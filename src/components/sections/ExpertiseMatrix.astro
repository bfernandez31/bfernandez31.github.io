---
import skillsData from "../../data/skills.json";

// Sort categories by display order
const categories = [...skillsData.categories].sort(
	(a, b) => a.displayOrder - b.displayOrder,
);

// Group skills by category, filtering for proficiencyLevel >= 2
const skillsByCategory = categories
	.map((category) => ({
		...category,
		skills: skillsData.skills
			.filter((skill) => skill.category === category.id && skill.proficiencyLevel >= 2)
			.sort((a, b) => b.proficiencyLevel - a.proficiencyLevel), // Sort by proficiency desc
	}))
	.filter((category) => category.skills.length > 0); // Only show categories with skills
---

<section class="expertise">
	<div class="expertise__container">
		<h2 class="expertise__title">Expertise Matrix</h2>
		<p class="expertise__subtitle">
			Technical skills and competencies across the stack
		</p>

		<div class="expertise__matrix">
			{
				skillsByCategory.map((category) => (
					<div class="expertise__category">
						<h3 class="expertise__category-title">{category.name}</h3>
						<div class="expertise__skills">
							{category.skills.map((skill) => (
								<div class="expertise__skill">
									<div class="expertise__skill-header">
										<span class="expertise__skill-name">{skill.name}</span>
										<span class="expertise__skill-years">
											{skill.yearsExperience}y
										</span>
									</div>
									<div class="expertise__skill-bar">
										<div
											class="expertise__skill-fill"
											style={`width: ${(skill.proficiencyLevel / 5) * 100}%`}
											data-level={skill.proficiencyLevel}
										/>
									</div>
									<div class="expertise__skill-tooltip">
										<p>
											<strong>Proficiency:</strong> {skill.proficiencyLevel}/5
										</p>
										<p>
											<strong>Experience:</strong> {skill.yearsExperience}{" "}
											years
										</p>
										{skill.relatedProjects.length > 0 && (
											<p>
												<strong>Projects:</strong>{" "}
												{skill.relatedProjects.length}
											</p>
										)}
									</div>
								</div>
							))}
						</div>
					</div>
				))
			}
		</div>
	</div>
</section>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";

	gsap.registerPlugin(ScrollTrigger);

	// Check for reduced motion preference
	const prefersReducedMotion = window.matchMedia(
		"(prefers-reduced-motion: reduce)",
	).matches;

	if (!prefersReducedMotion) {
		// Animate category cards on scroll
		const categories = document.querySelectorAll(".expertise__category");

		categories.forEach((category) => {
			gsap.fromTo(
				category,
				{
					opacity: 0,
					y: 30,
				},
				{
					opacity: 1,
					y: 0,
					duration: 0.6,
					ease: "power2.out",
					scrollTrigger: {
						trigger: category,
						start: "top 80%",
						toggleActions: "play none none none",
					},
				},
			);

			// Animate skill bars
			const skillFills = category.querySelectorAll(".expertise__skill-fill");
			skillFills.forEach((fill) => {
				gsap.fromTo(
					fill,
					{
						scaleX: 0,
					},
					{
						scaleX: 1,
						duration: 0.8,
						ease: "power2.out",
						scrollTrigger: {
							trigger: fill,
							start: "top 85%",
							toggleActions: "play none none none",
						},
					},
				);
			});
		});
	}

	// Clean up on page navigation
	document.addEventListener("astro:before-swap", () => {
		ScrollTrigger.getAll().forEach((trigger) => trigger.kill());
	});
</script>

<style>
	.expertise {
		padding: 4rem 2rem;
		min-height: 100vh;
		width: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.expertise__container {
		max-width: 1400px;
		width: 100%;
		margin: 0 auto;
	}

	.expertise__title {
		font-size: clamp(2.5rem, 5vw, 3.5rem);
		font-weight: 700;
		text-align: center;
		margin-bottom: 1rem;
		color: var(--color-text);
	}

	.expertise__subtitle {
		font-size: clamp(1rem, 2vw, 1.25rem);
		text-align: center;
		margin-bottom: 4rem;
		color: var(--color-text);
		opacity: 0.8;
	}

	.expertise__matrix {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 2rem;
	}

	.expertise__category {
		background: rgba(30, 30, 46, 0.95);
		border: 1px solid rgba(203, 166, 247, 0.3);
		border-radius: 12px;
		padding: 2rem;
		backdrop-filter: blur(10px);
		-webkit-backdrop-filter: blur(10px);
		transition: transform 0.3s ease, box-shadow 0.3s ease;
	}

	@media (hover: hover) {
		.expertise__category:hover {
			transform: translateY(-4px);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
		}
	}

	.expertise__category-title {
		font-size: 1.5rem;
		font-weight: 600;
		margin-bottom: 1.5rem;
		color: var(--color-primary);
		border-bottom: 2px solid var(--color-primary);
		padding-bottom: 0.5rem;
	}

	.expertise__skills {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.expertise__skill {
		position: relative;
	}

	.expertise__skill-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}

	.expertise__skill-name {
		font-size: 1.125rem;
		font-weight: 500;
		color: var(--color-text);
	}

	.expertise__skill-years {
		font-size: 0.875rem;
		font-weight: 400;
		color: var(--color-text);
		opacity: 0.6;
		font-family: "Fira Code", "Courier New", monospace;
	}

	.expertise__skill-bar {
		height: 8px;
		background: rgba(17, 17, 27, 0.8);
		border-radius: 4px;
		overflow: hidden;
		position: relative;
	}

	.expertise__skill-fill {
		height: 100%;
		background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
		border-radius: 4px;
		transform-origin: left;
		transition: background 0.3s ease;
	}

	.expertise__skill-fill[data-level="5"] {
		background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
	}

	.expertise__skill-fill[data-level="4"] {
		background: linear-gradient(90deg, var(--color-accent), var(--color-primary));
	}

	.expertise__skill-fill[data-level="3"] {
		background: linear-gradient(90deg, var(--color-accent), var(--color-text));
	}

	.expertise__skill-tooltip {
		position: absolute;
		top: 100%;
		left: 0;
		margin-top: 0.5rem;
		background: rgba(17, 17, 27, 0.98);
		border: 1px solid rgba(203, 166, 247, 0.3);
		border-radius: 8px;
		padding: 0.75rem 1rem;
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.3s ease;
		z-index: 10;
		min-width: 200px;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
	}

	.expertise__skill:hover .expertise__skill-tooltip {
		opacity: 1;
	}

	.expertise__skill-tooltip p {
		font-size: 0.875rem;
		color: var(--color-text);
		margin-bottom: 0.25rem;
	}

	.expertise__skill-tooltip p:last-child {
		margin-bottom: 0;
	}

	.expertise__skill-tooltip strong {
		color: var(--color-primary);
	}

	/* Mobile layout */
	@media (max-width: 768px) {
		.expertise {
			padding: 2rem 1rem;
		}

		.expertise__matrix {
			grid-template-columns: 1fr;
			gap: 1.5rem;
		}

		.expertise__category {
			padding: 1.5rem;
		}

		.expertise__skill-tooltip {
			position: static;
			opacity: 1;
			margin-top: 0.5rem;
			pointer-events: auto;
		}
	}

	/* Accessibility */
	@media (prefers-reduced-motion: reduce) {
		.expertise__category,
		.expertise__skill-fill {
			transition: none;
		}
	}
</style>
