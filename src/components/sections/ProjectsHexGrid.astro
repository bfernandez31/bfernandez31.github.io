---
import { getCollection } from "astro:content";

export interface Props {
	limit?: number;
	featured?: boolean;
}

const { limit = 12, featured = false } = Astro.props;

// Get all projects or filter by featured
let projects = await getCollection("projects");

if (featured) {
	projects = projects.filter((project) => project.data.featured);
}

// Sort by displayOrder field, then by startDate
projects.sort((a, b) => {
	const orderA = a.data.displayOrder ?? 999;
	const orderB = b.data.displayOrder ?? 999;
	if (orderA !== orderB) return orderA - orderB;
	return (
		new Date(b.data.startDate).getTime() - new Date(a.data.startDate).getTime()
	);
});

// Limit the number of projects
const displayProjects = projects.slice(0, limit);
---

<section class="hex-grid" data-projects-count={displayProjects.length}>
  <div class="hex-grid__container">
    <h2 class="hex-grid__title">Featured Projects</h2>

    <div class="hex-grid__wrapper">
      {displayProjects.map((project, index) => (
        <article
          class="hex-item"
          data-index={index}
          data-featured={project.data.featured}
        >
          <a
            href={`/projects/${project.slug}`}
            class="hex-item__link"
            aria-label={`View ${project.data.title} project`}
          >
            <div class="hex-item__hexagon">
              <div class="hex-item__image">
                <img
                  src={project.data.image || '/images/projects/placeholder.webp'}
                  alt={project.data.title}
                  loading={index < 6 ? 'eager' : 'lazy'}
                  decoding="async"
                />
              </div>

              <div class="hex-item__overlay">
                <h3 class="hex-item__title">{project.data.title}</h3>
                <p class="hex-item__description">{project.data.description}</p>

                <div class="hex-item__tech">
                  {project.data.technologies.slice(0, 3).map(tech => (
                    <span class="hex-item__tech-tag">{tech}</span>
                  ))}
                </div>
              </div>
            </div>
          </a>
        </article>
      ))}
    </div>

    {projects.length > limit && (
      <div class="hex-grid__more">
        <button
          class="hex-grid__load-more"
          data-remaining={projects.length - limit}
          aria-label="Load more projects"
        >
          Load More Projects
        </button>
      </div>
    )}
  </div>
</section>

<style>
  .hex-grid {
    padding: var(--spacing-xl) var(--spacing-base);
    min-height: 100vh;
  }

  .hex-grid__container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .hex-grid__title {
    font-size: clamp(2rem, 5vw, 3rem);
    color: var(--color-text);
    margin-bottom: var(--spacing-xl);
    text-align: center;
  }

  .hex-grid__wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 0 auto;
    padding: 20px 0;
  }

  /* Hexagon Base Styles */
  .hex-item {
    position: relative;
    width: 200px;
    height: 230px;
    margin: 10px;
    transition: transform var(--transition-normal);
  }

  .hex-item__link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .hex-item__hexagon {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    visibility: hidden;
    transform: rotate(120deg);
    transition: all var(--transition-normal);
  }

  .hex-item__hexagon::before,
  .hex-item__hexagon::after {
    content: "";
    position: absolute;
    width: 200%;
    height: 100%;
    left: -50%;
    background: var(--color-surface);
    visibility: visible;
    transform-origin: center;
  }

  .hex-item__hexagon::before {
    transform: rotate(60deg);
  }

  .hex-item__hexagon::after {
    transform: rotate(-60deg);
  }

  /* Hexagon Image */
  .hex-item__image {
    position: absolute;
    width: 100%;
    height: 100%;
    visibility: visible;
    transform: rotate(-120deg);
    overflow: hidden;
  }

  .hex-item__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-normal);
  }

  /* Hexagon Overlay */
  .hex-item__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    visibility: visible;
    transform: rotate(-120deg);
    background: linear-gradient(
      to bottom,
      transparent 0%,
      rgba(var(--color-background-rgb), 0.9) 50%,
      rgba(var(--color-background-rgb), 0.98) 100%
    );
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 20px;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .hex-item__title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
  }

  .hex-item__description {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .hex-item__tech {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .hex-item__tech-tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-primary-subtle);
    color: var(--color-primary);
    border-radius: var(--radius-small);
  }

  /* Hover Effects */
  .hex-item:hover {
    transform: scale(1.08);
    z-index: 10;
  }

  .hex-item:hover .hex-item__overlay {
    opacity: 1;
  }

  .hex-item:hover .hex-item__image img {
    transform: scale(1.1);
  }

  /* CSS-only hexagonal grid using clip-path (simpler approach) */
  @supports (clip-path: polygon(0 0)) {
    .hex-item__hexagon,
    .hex-item__hexagon::before,
    .hex-item__hexagon::after {
      all: unset;
    }

    .hex-item {
      width: clamp(150px, 20vw, 250px);
      aspect-ratio: 1 / 1.15;
      margin: 0;
    }

    .hex-item__hexagon {
      width: 100%;
      height: 100%;
      clip-path: polygon(
        30% 0%,
        70% 0%,
        100% 30%,
        100% 70%,
        70% 100%,
        30% 100%,
        0% 70%,
        0% 30%
      );
      background: var(--color-surface);
      position: relative;
      overflow: hidden;
      visibility: visible;
      transform: none;
    }

    .hex-item__image {
      transform: none;
      width: 100%;
      height: 100%;
    }

    .hex-item__overlay {
      transform: none;
    }

    /* Hexagonal grid layout using nth-child offsets */
    .hex-grid__wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 5px;
      max-width: 1200px;
    }

    @media (min-width: 768px) {
      .hex-item:nth-child(even) {
        transform: translateY(50%);
      }

      .hex-item:hover {
        transform: scale(1.08);
        z-index: 10;
      }

      .hex-item:nth-child(even):hover {
        transform: translateY(50%) scale(1.08);
      }
    }
  }

  /* Mobile fallback: Rounded cards */
  @media (max-width: 767px) {
    .hex-item {
      width: 100%;
      max-width: 350px;
      height: auto;
      aspect-ratio: 16 / 10;
    }

    .hex-item__hexagon {
      clip-path: none;
      border-radius: var(--radius-large);
      overflow: hidden;
    }

    .hex-item:nth-child(even) {
      transform: none;
    }
  }

  /* Very small screens: Simple cards */
  @media (max-width: 374px) {
    .hex-grid__wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .hex-item__overlay {
      opacity: 1;
      background: linear-gradient(
        to bottom,
        transparent 0%,
        rgba(var(--color-background-rgb), 0.7) 40%,
        rgba(var(--color-background-rgb), 0.95) 100%
      );
    }
  }

  /* Load more button */
  .hex-grid__more {
    margin-top: var(--spacing-xl);
    text-align: center;
  }

  .hex-grid__load-more {
    padding: var(--spacing-small) var(--spacing-large);
    background: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-medium);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .hex-grid__load-more:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
  }

  .hex-grid__load-more:active {
    transform: translateY(0);
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .hex-item,
    .hex-item__image img,
    .hex-item__overlay,
    .hex-grid__load-more {
      transition: none;
    }

    .hex-item:hover {
      transform: none;
    }

    .hex-item:nth-child(even):hover {
      transform: translateY(50%);
    }
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Only run animations if not reduced motion
  if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    gsap.registerPlugin(ScrollTrigger);

    // Entrance animation for hexagons
    const hexItems = document.querySelectorAll('.hex-item');

    hexItems.forEach((item, index) => {
      gsap.fromTo(item,
        {
          opacity: 0,
          scale: 0.8,
          y: 30,
        },
        {
          opacity: 1,
          scale: 1,
          y: 0,
          duration: 0.6,
          delay: index * 0.05,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: item,
            start: 'top 90%',
            once: true,
          }
        }
      );
    });
  }

  // Load more functionality
  const loadMoreBtn = document.querySelector('.hex-grid__load-more') as HTMLButtonElement | null;

  if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', async () => {
      // This would typically fetch more projects via API
      // For now, just show a loading state
      loadMoreBtn.textContent = 'Loading...';
      loadMoreBtn.disabled = true;

      // Simulate loading
      setTimeout(() => {
        loadMoreBtn.textContent = 'No more projects';
        loadMoreBtn.disabled = true;
      }, 1000);
    });
  }

  // Clean up on navigation
  document.addEventListener('astro:before-swap', () => {
    ScrollTrigger.killAll();
  });
</script>