---
/**
 * TuiLayout Component
 * Feature: PBF-32-portofolio-with-tui
 *
 * Main TUI layout container integrating TopBar, Sidebar, content, StatusLine, CommandLine
 */

import TopBar from "./TopBar.astro";
import Sidebar from "./Sidebar.astro";
import StatusLine from "./StatusLine.astro";
import CommandLine from "./CommandLine.astro";
import LineNumbers from "../ui/LineNumbers.astro";
import type { SectionId } from "../../types/tui";
import {
	TUI_SECTIONS,
	generateBufferTabs,
	generateFileEntries,
} from "../../data/sections";

interface Props {
	/** Initial active section */
	activeSectionId?: SectionId;
	/** Show line numbers gutter */
	showLineNumbers?: boolean;
	/** Number of lines for line numbers gutter */
	lineCount?: number;
}

const {
	activeSectionId = "hero",
	showLineNumbers = true,
	lineCount = 50,
} = Astro.props;

// Generate tabs and files from section config
const tabs = generateBufferTabs(activeSectionId);
const files = generateFileEntries(activeSectionId);

// Get active section info for per-section line numbers (PBF-37)
const activeSection = TUI_SECTIONS.find((s) => s.id === activeSectionId);
const activeFileName = activeSection?.fileName || "hero.tsx";
const activeLineCount = activeSection?.lineCount || lineCount;
---

<div class="tui-layout">
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="tui-skip-link">Skip to main content</a>

  <!-- Sidebar overlay (mobile) -->
  <div class="tui-sidebar-overlay" aria-hidden="true"></div>

  <!-- tmux-style top bar -->
  <TopBar
    tabs={tabs}
    sessionName="portfolio"
    gitBranch="main"
    showClock={true}
    showSidebarToggle={true}
  />

  <!-- NvimTree sidebar (grid-area: sidebar) -->
  <Sidebar
    files={files}
    activeSectionId={activeSectionId}
  />

  <!-- Content area (grid-area: content) -->
  <main id="main-content" class="tui-content">
    {showLineNumbers && (
      <div class="tui-content__gutter" id="tui-line-gutter">
        <LineNumbers
          sectionId={activeSectionId}
          lineCount={activeLineCount}
        />
      </div>
    )}
    <div class="tui-content__viewport">
      <!-- Section container for horizontal slide navigation (PBF-37) -->
      <div class="tui-section-container">
        <slot />
      </div>
    </div>
  </main>

  <!-- Neovim statusline -->
  <StatusLine
    mode="NORMAL"
    activeFile={activeFileName}
    line={1}
    column={1}
    fileType="typescriptreact"
    gitBranch="main"
  />

  <!-- Command line -->
  <CommandLine
    prompt=":"
    content={`e ${activeFileName}`}
    isVisible={true}
  />
</div>

<style>
  /* Viewport sizing and visual properties only - grid layout defined in layout.css */
  .tui-layout {
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    background-color: var(--color-background, #1e1e2e);
    color: var(--color-text, #cdd6f4);
    font-family: var(--font-mono, monospace);
  }

  /* Content sub-components */
  .tui-content__gutter {
    flex-shrink: 0;
    width: 3rem;
    padding: 0.5rem 0;
    text-align: right;
    color: var(--color-text-muted, #6c7086);
    background-color: var(--color-surface-0, #1e1e2e);
    border-right: 1px solid var(--color-surface-1, #313244);
    user-select: none;
    overflow: hidden;
  }

  .tui-content__viewport {
    flex: 1;
    padding: 0;
    overflow: hidden;
    scroll-behavior: smooth;
    /* Required for absolute children to inherit size */
    position: relative;
  }

  /* Sidebar overlay (mobile) */
  .tui-sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 150;
  }

  .tui-sidebar-overlay.is-visible {
    display: block;
  }

  /* Skip link */
  .tui-skip-link {
    position: absolute;
    top: -100%;
    left: 0;
    padding: 0.5rem 1rem;
    background-color: var(--color-primary, #cba6f7);
    color: var(--color-background, #1e1e2e);
    z-index: 1000;
    text-decoration: none;
    font-family: var(--font-mono, monospace);
  }

  .tui-skip-link:focus {
    top: 0;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .tui-content__gutter {
      width: 2.5rem;
      font-size: 0.75rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .tui-content__viewport {
      scroll-behavior: auto;
    }
  }
</style>

<script>
  import type { SectionId, SectionChangeEventDetail } from '../../types/tui';
  import { TUI_SECTIONS } from '../../data/sections';

  // Per-section line numbers (PBF-37)
  // Update line numbers when section changes
  function updateLineNumbers(sectionId: SectionId): void {
    const gutter = document.getElementById('tui-line-gutter');
    if (!gutter) return;

    const section = TUI_SECTIONS.find(s => s.id === sectionId);
    if (!section) return;

    const lineCount = section.lineCount;

    // Generate new line numbers HTML
    const lines = Array.from({ length: lineCount }, (_, i) => i + 1);
    const linesHtml = lines.map(num => `<span class="tui-line-numbers__line">${num}</span>`).join('');

    // Update the gutter content
    const lineNumbersContainer = gutter.querySelector('.tui-line-numbers');
    if (lineNumbersContainer) {
      lineNumbersContainer.innerHTML = linesHtml;
      lineNumbersContainer.setAttribute('data-section-id', sectionId);
    }
  }

  // Listen for section changes
  document.addEventListener('tui:section-change', ((event: CustomEvent<SectionChangeEventDetail>) => {
    updateLineNumbers(event.detail.currentSectionId);
  }) as EventListener);
</script>
