---
/**
 * TuiLayout Component
 * Feature: PBF-32-portofolio-with-tui
 *
 * Main TUI layout container integrating TopBar, Sidebar, content, StatusLine, CommandLine
 */

import TopBar from "./TopBar.astro";
import Sidebar from "./Sidebar.astro";
import StatusLine from "./StatusLine.astro";
import CommandLine from "./CommandLine.astro";
import LineNumbers from "../ui/LineNumbers.astro";
import type { SectionId } from "../../types/tui";
import {
	TUI_SECTIONS,
	generateBufferTabs,
	generateFileEntries,
} from "../../data/sections";

interface Props {
	/** Initial active section */
	activeSectionId?: SectionId;
	/** Show line numbers gutter */
	showLineNumbers?: boolean;
	/** Number of lines for line numbers gutter */
	lineCount?: number;
}

const {
	activeSectionId = "hero",
	showLineNumbers = true,
	lineCount = 50,
} = Astro.props;

// Generate tabs and files from section config
const tabs = generateBufferTabs(activeSectionId);
const files = generateFileEntries(activeSectionId);

// Get active section info for per-section line numbers (PBF-37)
const activeSection = TUI_SECTIONS.find((s) => s.id === activeSectionId);
const activeFileName = activeSection?.fileName || "hero.tsx";
const activeLineCount = activeSection?.lineCount || lineCount;
---

<div class="tui-layout">
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="tui-skip-link">Skip to main content</a>

  <!-- Sidebar overlay (mobile) -->
  <div class="tui-sidebar-overlay" aria-hidden="true"></div>

  <!-- tmux-style top bar -->
  <TopBar
    tabs={tabs}
    sessionName="portfolio"
    gitBranch="main"
    showClock={true}
    showSidebarToggle={true}
  />

  <!-- NvimTree sidebar (grid-area: sidebar) -->
  <Sidebar
    files={files}
    activeSectionId={activeSectionId}
  />

  <!-- Content area (grid-area: content) -->
  <main id="main-content" class="tui-content">
    {showLineNumbers && (
      <div class="tui-content__gutter" id="tui-line-gutter">
        <LineNumbers
          sectionId={activeSectionId}
          lineCount={activeLineCount}
        />
      </div>
    )}
    <div class="tui-content__viewport">
      <!-- Section container for horizontal slide navigation (PBF-37) -->
      <div class="tui-section-container">
        <slot />
      </div>
    </div>
  </main>

  <!-- Neovim statusline -->
  <StatusLine
    mode="NORMAL"
    activeFile={activeFileName}
    line={1}
    column={1}
    fileType="typescriptreact"
    gitBranch="main"
  />

  <!-- Command line -->
  <CommandLine
    prompt=":"
    content={`e ${activeFileName}`}
    isVisible={true}
  />
</div>

<style>
  /* Viewport sizing and visual properties only - grid layout defined in layout.css */
  .tui-layout {
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    background-color: var(--color-background, #1e1e2e);
    color: var(--color-text, #cdd6f4);
    font-family: var(--font-mono, monospace);
  }

  /* Content sub-components */
  .tui-content__gutter {
    flex-shrink: 0;
    width: 3rem;
    padding: 0.5rem 0;
    text-align: right;
    color: var(--color-text-muted, #6c7086);
    background-color: var(--color-surface-0, #1e1e2e);
    border-right: 1px solid var(--color-surface-1, #313244);
    user-select: none;
    overflow-y: auto;
    overflow-x: hidden;
    /* Sync scroll with content viewport */
    scrollbar-width: none;
  }

  .tui-content__gutter::-webkit-scrollbar {
    display: none;
  }

  .tui-content__viewport {
    flex: 1;
    padding: 0;
    overflow: hidden;
    scroll-behavior: smooth;
    /* Required for absolute children to inherit size */
    position: relative;
  }

  /* Sidebar overlay (mobile) */
  .tui-sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 150;
  }

  .tui-sidebar-overlay.is-visible {
    display: block;
  }

  /* Skip link */
  .tui-skip-link {
    position: absolute;
    top: -100%;
    left: 0;
    padding: 0.5rem 1rem;
    background-color: var(--color-primary, #cba6f7);
    color: var(--color-background, #1e1e2e);
    z-index: 1000;
    text-decoration: none;
    font-family: var(--font-mono, monospace);
  }

  .tui-skip-link:focus {
    top: 0;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .tui-content__gutter {
      width: 2.5rem;
      font-size: 0.75rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .tui-content__viewport {
      scroll-behavior: auto;
    }
  }
</style>

<script>
  import type { SectionId, SectionChangeEventDetail } from '../../types/tui';
  import { TUI_SECTIONS } from '../../data/sections';

  // Per-section line numbers (PBF-37 + PBF-40)
  // Update line numbers when section changes, dynamically calculating line count based on content height
  function updateLineNumbers(sectionId: SectionId): void {
    const gutter = document.getElementById('tui-line-gutter');
    if (!gutter) return;

    const section = TUI_SECTIONS.find(s => s.id === sectionId);
    if (!section) return;

    // Get the active section element to measure its scrollable height
    const sectionElement = document.querySelector(`[data-section="${sectionId}"]`);
    if (!sectionElement) return;

    // Calculate line count based on content scroll height
    // Use a standard line height (1.6 * 0.75rem â‰ˆ 18px at default font size)
    const lineHeight = 18; // pixels
    const scrollHeight = sectionElement.scrollHeight;

    // Calculate how many lines are needed to cover the full scrollable area
    // Use at least the configured lineCount, but extend if content is taller
    const minLineCount = section.lineCount;
    const calculatedLineCount = Math.max(minLineCount, Math.ceil(scrollHeight / lineHeight));

    // Generate new line numbers HTML
    const lines = Array.from({ length: calculatedLineCount }, (_, i) => i + 1);
    const linesHtml = lines.map(num => `<span class="tui-line-numbers__line">${num}</span>`).join('');

    // Update the gutter content
    const lineNumbersContainer = gutter.querySelector('.tui-line-numbers');
    if (lineNumbersContainer) {
      lineNumbersContainer.innerHTML = linesHtml;
      lineNumbersContainer.setAttribute('data-section-id', sectionId);
    }
  }

  // Synchronize scroll between gutter and content (PBF-40)
  function syncScroll(): void {
    const gutter = document.getElementById('tui-line-gutter');
    const viewport = document.querySelector('.tui-content__viewport');

    if (!gutter || !viewport) return;

    // Get the active section
    const activeSection = document.querySelector('.tui-section.is-active') as HTMLElement;
    if (!activeSection) return;

    // Sync gutter scroll to match active section scroll
    let isScrolling = false;

    activeSection.addEventListener('scroll', () => {
      if (!isScrolling) {
        isScrolling = true;
        requestAnimationFrame(() => {
          gutter.scrollTop = activeSection.scrollTop;
          isScrolling = false;
        });
      }
    });

    // Also sync when gutter is scrolled (though it's user-select: none, still accessible via keyboard)
    gutter.addEventListener('scroll', () => {
      if (!isScrolling) {
        isScrolling = true;
        requestAnimationFrame(() => {
          activeSection.scrollTop = gutter.scrollTop;
          isScrolling = false;
        });
      }
    });
  }

  // Listen for section changes
  document.addEventListener('tui:section-change', ((event: CustomEvent<SectionChangeEventDetail>) => {
    updateLineNumbers(event.detail.currentSectionId);
    // Re-setup scroll sync for the new active section
    setTimeout(syncScroll, 100); // Small delay to ensure DOM is ready
  }) as EventListener);

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Update line numbers for initial section
    const initialSection = document.querySelector('.tui-section.is-active') as HTMLElement;
    if (initialSection) {
      const sectionId = initialSection.getAttribute('data-section') as SectionId;
      if (sectionId) {
        updateLineNumbers(sectionId);
      }
    }

    // Setup initial scroll sync
    syncScroll();

    // Re-calculate line numbers on window resize
    window.addEventListener('resize', () => {
      const activeSection = document.querySelector('.tui-section.is-active') as HTMLElement;
      if (activeSection) {
        const sectionId = activeSection.getAttribute('data-section') as SectionId;
        if (sectionId) {
          updateLineNumbers(sectionId);
        }
      }
    });
  });
</script>
