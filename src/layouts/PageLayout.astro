---
import BaseLayout from "./BaseLayout.astro";
import TuiLayout from "../components/layout/TuiLayout.astro";
import type { SectionId } from "../types/tui";

export interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	noindex?: boolean;
	canonicalUrl?: string;
	/** Initial active section for TUI layout */
	activeSectionId?: SectionId;
	/** Show TUI line numbers gutter */
	showLineNumbers?: boolean;
}

const {
	title,
	description,
	ogImage,
	noindex,
	canonicalUrl,
	activeSectionId = 'hero',
	showLineNumbers = true,
} = Astro.props;
---

<BaseLayout
	title={title}
	description={description}
	ogImage={ogImage}
	noindex={noindex}
	canonicalUrl={canonicalUrl}
>
	<TuiLayout
		activeSectionId={activeSectionId}
		showLineNumbers={showLineNumbers}
	>
		<slot />
	</TuiLayout>
</BaseLayout>

<script>
	import { detectDeviceTier } from '../scripts/performance/device-tier';

	// Progressive enhancement wrapper (T049) - ensure animations never break core functionality
	try {
		// Detect device tier on page load (before other scripts)
		const deviceTierResult = detectDeviceTier();
		console.log('Device Tier:', deviceTierResult.tier);
		console.log('Reasons:', deviceTierResult.reasons);
		console.log('Capabilities:', deviceTierResult.capabilities);

		// Store globally for other scripts to access
		(window as any).__DEVICE_TIER__ = deviceTierResult;

		// Expose as CSS custom property for styling-based optimizations
		document.documentElement.style.setProperty('--device-tier', deviceTierResult.tier.toLowerCase());

		// Initialize performance monitor in development mode only
		if (import.meta.env.DEV) {
			import('../scripts/performance/performance-monitor').then((module) => {
				module.performanceMonitor.startMonitoring();

				// Check budget every 5 seconds and log violations
				import('../config/performance').then((config) => {
					setInterval(() => {
						module.performanceMonitor.checkBudget(config.PERFORMANCE_CONFIG.budget);
					}, 5000);
				});

				// Log report every 30 seconds
				setInterval(() => {
					console.log(module.performanceMonitor.getReport());
				}, 30000);
			}).catch((error) => {
				console.error('[PageLayout] Failed to load performance monitor:', error);
			});
		}
	} catch (error) {
		// Progressive enhancement: Site remains fully functional if device tier detection fails
		console.error('[PageLayout] Failed to initialize device tier detection:', error);
		console.log('[PageLayout] Site will continue with default behavior');
		// Set fallback device tier
		(window as any).__DEVICE_TIER__ = { tier: 'MID', reasons: ['fallback'], capabilities: {} };
	}
</script>

